<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Bus Schedule</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <link rel="stylesheet" href="./style.css">
</head>

<body>
  <!-- partial:index.partial.html -->
  <section class="section-container">
    <h1 class="heading">Schedule</h1>
    <p id="loading">
      Currently Loading <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" width="25px" height="25px" style="shape-rendering: auto; display: block; background: none;"><g><circle stroke-dasharray="164.93361431346415 56.97787143782138" r="35" stroke-width="10" stroke="#ffffff" fill="none" cy="50" cx="50">
        <animateTransform keyTimes="0;1" values="0 50 50;360 50 50" dur="1s" repeatCount="indefinite" type="rotate" attributeName="transform"/>
      </circle><g/></g><!-- [ldio] generated by https://loading.io --></svg>
    </p>
  </section>

  <hr class="divider" />
  <svg class="filter" xmlns="http://www.w3.org/2000/svg" version="1.1">
    <defs>
      <filter id="blur">
        <feGaussianBlur in="SourceGraphic" stdDeviation="0,0"></feGaussianBlur>
      </filter>
    </defs>
  </svg>
  <div class="schedule-container">
    <div class="schedule-stage__wrapper">
      <section class="schedule-stage">
        <div class="schedule-stage__title">
          <h3>Bus: 16</h3>
        </div>
        <div id="scheduleBus16" class="schedule-stage_guide-container">
          <!-- Fetched data will be appended here -->
        </div>
      </section>
    </div>
  </div>
  <div class="schedule-container">
    <div class="schedule-stage__wrapper">
      <section class="schedule-stage">
        <div class="schedule-stage__title">
          <h3>Bus: B1</h3>
        </div>
        <div id="scheduleBusB1" class="schedule-stage_guide-container">
          <!-- Fetched data will be appended here -->
        </div>
      </section>
    </div>
  </div>
  <!-- partial -->
  <script src='jquery.min.js'></script>
  <script src='jquery.scrollTo.min.js'></script>
  <script>
    // Scroll to specific values
    // scrollTo is the same
    window.scroll({
      top: 2500,
      left: 0,
      behavior: 'smooth'
    });

    // Scroll certain amounts from current position 
    window.scrollBy({
      top: 100, // could be negative value
      left: 0,
      behavior: 'smooth'
    });

    // Scroll to a certain element
    document.querySelector('.schedule-container').scrollIntoView({
      behavior: 'smooth'
    })
    document.addEventListener('DOMContentLoaded', function () {
      var containers = document.querySelectorAll('.schedule-container');

      containers.forEach(function (container) {
        container.addEventListener('wheel', function (e) {
          // Adjust the horizontal scroll position based on the wheel delta
          container.scrollLeft += e.deltaY;

          // Prevent the default vertical scrolling behavior
          e.preventDefault();
        });
      });

    });
    function formatTime(dateTimeString) {
      const date = new Date(dateTimeString);
      return date.toTimeString().slice(0, 5);
    }

    function extractHours(timeString) {
      let [hours] = timeString.split(':');
      return Number(hours).toString(); // Convert to number and back to string to remove leading zeros
    }
    async function fetchBusSchedule() {
      fetchBusSchedule2()
      try {
        const targetUrl = encodeURIComponent('https://telematics.oasa.gr/api/?act=getDailySchedule&line_code=1076&keyOrigin=evoxEpsilon');
        const response = await fetch(`https://data.evoxs.xyz/proxy?key=21&targetUrl=${targetUrl}`);
        const data = await response.json();
        const scheduleContainer = document.getElementById('scheduleBus16');

        // Clear existing content
        scheduleContainer.innerHTML = '';
        document.getElementById("loading").innerHTML = "Welcome!"
        const times = data.go.map(item => formatTime(item.sde_start1));
        let count = 0;

        times.forEach(schedule => {
          //if (count > 0 && count % 4 === 0) {
          //      htmlContent += '<br>';
          //}
          const singleTime = extractHours(schedule)

          if (document.getElementById(`time${singleTime}`)) {
            document.getElementById(`time${singleTime}`).innerHTML = `${document.getElementById(`time${singleTime}`).innerHTML}<div class="guide-slot_card"><h4>${schedule}</h4><figure class="author-wrapper"><picture><img src="https://randomuser.me/api/portraits/lego/1.jpg" alt="Driver image"></picture><figcaption>Bus 16 Driver</figcaption></figure></div>`
            return;
          }
          const guideSlot = document.createElement('div');
          guideSlot.className = 'guide-slot';
          guideSlot.id = `time${singleTime}`

          const time = document.createElement('p');
          //const departureTime = new Date(schedule.attributes.departure_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          //const arrivalTime = new Date(schedule.attributes.arrival_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          let textTime;
          if(singleTime > 12) {
            textTime = singleTime - 12 + " PM"
          } else {
            textTime = singleTime + " AM"
          }
          time.textContent = `${textTime}`;
          guideSlot.appendChild(time);

          const guideSlotCard = document.createElement('div');
          guideSlotCard.className = 'guide-slot_card';

          const h4 = document.createElement('h4');
          h4.textContent = `${schedule}`;
          guideSlotCard.appendChild(h4);

          const figure = document.createElement('figure');
          figure.className = 'author-wrapper';

          const picture = document.createElement('picture');
          const img = document.createElement('img');
          img.src = 'https://randomuser.me/api/portraits/lego/1.jpg';  // Placeholder image
          img.alt = 'Driver image';  // Placeholder alt text
          picture.appendChild(img);
          figure.appendChild(picture);

          const figcaption = document.createElement('figcaption');
          figcaption.textContent = 'Bus 16 Driver';  // Placeholder driver name
          figure.appendChild(figcaption);

          guideSlotCard.appendChild(figure);
          guideSlot.appendChild(guideSlotCard);
          scheduleContainer.appendChild(guideSlot);
        });

      } catch (error) {
        console.error('Error fetching bus schedule:', error);
      }
    }

    async function fetchBusSchedule2() {
      try {
        const targetUrl = encodeURIComponent('https://telematics.oasa.gr/api/?act=getDailySchedule&line_code=871&keyOrigin=evoxEpsilon');
        const response = await fetch(`https://data.evoxs.xyz/proxy?key=21&targetUrl=${targetUrl}`);
        const data = await response.json();
        const scheduleContainer = document.getElementById('scheduleBusB1');

        // Clear existing content
        scheduleContainer.innerHTML = '';
        const times = data.go.map(item => formatTime(item.sde_start1));
        let count = 0;

        times.forEach(schedule => {
          //if (count > 0 && count % 4 === 0) {
          //      htmlContent += '<br>';
          //}
          const singleTime = extractHours(schedule)

          if (document.getElementById(`B1time${singleTime}`)) {
            document.getElementById(`B1time${singleTime}`).innerHTML = `${document.getElementById(`B1time${singleTime}`).innerHTML}<div class="guide-slot_card"><h4>${schedule}</h4><figure class="author-wrapper"><picture><img src="https://randomuser.me/api/portraits/lego/1.jpg" alt="Driver image"></picture><figcaption>Bus Driver</figcaption></figure></div>`
            return;
          }
          const guideSlot = document.createElement('div');
          guideSlot.className = 'guide-slot';
          guideSlot.id = `B1time${singleTime}`

          const time = document.createElement('p');
          //const departureTime = new Date(schedule.attributes.departure_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          //const arrivalTime = new Date(schedule.attributes.arrival_time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          let textTime2;
          if(singleTime > 12) {
            textTime2 = singleTime - 12 + " PM"
          } else {
            textTime2 = singleTime + " AM"
          }
          time.textContent = `${textTime2}`;
          guideSlot.appendChild(time);

          const guideSlotCard = document.createElement('div');
          guideSlotCard.className = 'guide-slot_card';

          const h4 = document.createElement('h4');
          h4.textContent = `${schedule}`;
          guideSlotCard.appendChild(h4);

          const figure = document.createElement('figure');
          figure.className = 'author-wrapper';

          const picture = document.createElement('picture');
          const img = document.createElement('img');
          img.src = 'https://randomuser.me/api/portraits/lego/1.jpg';  // Placeholder image
          img.alt = 'Driver image';  // Placeholder alt text
          picture.appendChild(img);
          figure.appendChild(picture);

          const figcaption = document.createElement('figcaption');
          figcaption.textContent = 'Bus Driver';  // Placeholder driver name
          figure.appendChild(figcaption);

          guideSlotCard.appendChild(figure);
          guideSlot.appendChild(guideSlotCard);
          scheduleContainer.appendChild(guideSlot);
        });

      } catch (error) {
        console.error('Error fetching bus schedule:', error);
      }
    }

    // Call fetchBusSchedule function

    document.addEventListener('DOMContentLoaded', fetchBusSchedule);
  </script>
</body>

</html>